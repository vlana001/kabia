<%- include('../includes/head.ejs') %>
<link rel="stylesheet" href="/css/styles.css">


</head>

<body>


    <script type='text/javascript'>
        //if code is autoformated put the - next to percent sign
        var servers = <%- JSON.parse(stunTurnServers) %>;
    </script>

    <%- include('../includes/navigation.ejs') %>
    <div class="content flex">
        <div id="container-page" class="flex1">
            <div id="page-content" class="containerVideo">

                <div id="callPage" class="call-page">

                    <video id="localVideo" autoplay muted="muted"></video>
                    <video id="remoteVideo" autoplay></video>

                    <div id="show-msg">
                        <p id="msg-text"></p>
                    </div>
                    <img id="remoteuser-image" src="/uploads/<%=userImage%>" alt="">


                    <div id="call-btn">
                        <div id="callIcon">
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                                version="1.1" viewBox="0 0 24 24" class="phone-call-icon" transform="translate(10,10)">
                                <path
                                    d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z">
                                </path>
                            </svg>
                        </div>
                        <div id="hangupIcon">
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                                version="1.1" viewBox="0 0 24 24" class="phone-call-icon" transform="translate(10,10)">
                                <path
                                    d="M12,9C10.4,9 8.85,9.25 7.4,9.72V12.82C7.4,13.22 7.17,13.56 6.84,13.72C5.86,14.21 4.97,14.84 4.17,15.57C4,15.75 3.75,15.86 3.5,15.86C3.2,15.86 2.95,15.74 2.77,15.56L0.29,13.08C0.11,12.9 0,12.65 0,12.38C0,12.1 0.11,11.85 0.29,11.67C3.34,8.77 7.46,7 12,7C16.54,7 20.66,8.77 23.71,11.67C23.89,11.85 24,12.1 24,12.38C24,12.65 23.89,12.9 23.71,13.08L21.23,15.56C21.05,15.74 20.8,15.86 20.5,15.86C20.25,15.86 20,15.75 19.82,15.57C19.03,14.84 18.14,14.21 17.16,13.72C16.83,13.56 16.6,13.22 16.6,12.82V9.72C15.15,9.25 13.6,9 12,9Z">
                                </path>
                            </svg>
                        </div>


                    </div>

                    <div id="video-buttons">
                        <div id="mute-audio-btn">
                            <svg id="mute-audio" xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                                viewBox="0 0 68 68">
                                <path id="muted-audio-icon" transform="scale(0.9), translate(14,15)"
                                    d="M38 22h-3.4c0 1.49-.31 2.87-.87 4.1l2.46 2.46C37.33 26.61 38 24.38 38 22zm-8.03.33c0-.11.03-.22.03-.33V10c0-3.32-2.69-6-6-6s-6 2.68-6 6v.37l11.97 11.96zM8.55 6L6 8.55l12.02 12.02v1.44c0 3.31 2.67 6 5.98 6 .45 0 .88-.06 1.3-.15l3.32 3.32c-1.43.66-3 1.03-4.62 1.03-5.52 0-10.6-4.2-10.6-10.2H10c0 6.83 5.44 12.47 12 13.44V42h4v-6.56c1.81-.27 3.53-.9 5.08-1.81L39.45 42 42 39.46 8.55 6z"
                                    fill="white"></path>
                                <path id="unmuted-audio-icon" transform="scale(0.9), translate(14,15)"
                                    d="M24 28c3.31 0 5.98-2.69 5.98-6L30 10c0-3.32-2.68-6-6-6-3.31 0-6 2.68-6 6v12c0 3.31 2.69 6 6 6zm10.6-6c0 6-5.07 10.2-10.6 10.2-5.52 0-10.6-4.2-10.6-10.2H10c0 6.83 5.44 12.47 12 13.44V42h4v-6.56c6.56-.97 12-6.61 12-13.44h-3.4z"
                                    fill="white"></path>
                            </svg>
                        </div>

                        <div id="mute-video-btn">
                            <svg id="mute-video" xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                                viewBox="0 0 68 68">
                                <path id="muted-video-icon" transform="scale(0.9), translate(14,15)"
                                    d="M40 8H15.64l8 8H28v4.36l1.13 1.13L36 16v12.36l7.97 7.97L44 36V12c0-2.21-1.79-4-4-4zM4.55 2L2 4.55l4.01 4.01C4.81 9.24 4 10.52 4 12v24c0 2.21 1.79 4 4 4h29.45l4 4L44 41.46 4.55 2zM12 16h1.45L28 30.55V32H12V16z"
                                    fill="white"></path>
                                <path id="unmuted-video-icon" transform="scale(0.9), translate(14,15)"
                                    d="M40 8H8c-2.21 0-4 1.79-4 4v24c0 2.21 1.79 4 4 4h32c2.21 0 4-1.79 4-4V12c0-2.21-1.79-4-4-4zm-4 24l-8-6.4V32H12V16h16v6.4l8-6.4v16z"
                                    fill="white"></path>
                            </svg>
                        </div>

                        <div id="screen-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="svg-video" id="exit-fullscreen-icon"
                                version="1.0" viewBox="0 0 500 500" preserveAspectRatio="xMidYMid meet">
                                <g transform="translate(132,640) scale(0.1,-0.1)" stroke="none">
                                    <path
                                        d="M595 4505 c-18 -17 -25 -35 -25 -62 0 -36 10 -48 205 -243 113 -113 205 -207 205 -211 0 -3 -45 -5 -100 -5 -96 0 -102 -2 -127 -27 -36 -36 -37 -88 -2 -123 l26 -25 231 0 c146 0 239 4 252 11 31 17 35 49 35 283 l-1 217 -27 27 c-35 35 -86 37 -122 3 -24 -22 -25 -29 -25 -127 0 -57 -3 -103 -8 -103 -4 0 -99 92 -212 205 -195 195 -207 205 -243 205 -27 0 -45 -7 -62 -25z">
                                    </path>

                                    <path
                                        d="M1910 4325 c-113 -113 -208 -205 -212 -205 -5 0 -8 46 -8 103 0 98 -1 105 -25 127 -36 34 -87 32 -123 -3 l-27 -27 0 -218 c0 -119 3 -229 8 -244 13 -47 32 -50 281 -49 231 2 231 2 256 26 33 33 33 87 0 120 -23 22 -34 25 -127 27 -57 2 -103 5 -103 8 0 2 92 97 205 210 193 194 205 208 205 243 0 52 -35 87 -87 87 -36 0 -48 -10 -243 -205z">
                                    </path>
                                    <path
                                        d="M773 3518 c-12 -6 -29 -26 -38 -45 -14 -29 -15 -40 -4 -64 20 -50 43 -59 151 -59 54 0 98 -3 98 -8 0 -4 -92 -99 -205 -212 -195 -195 -205 -207 -205 -243 0 -52 35 -87 87 -87 35 0 49 12 243 205 113 113 209 205 213 205 4 0 7 -45 7 -100 0 -94 2 -103 25 -125 32 -33 87 -34 119 -1 32 31 40 122 32 332 -8 175 -14 197 -67 208 -53 10 -432 6 -456 -6z">
                                    </path>
                                    <path
                                        d="M1572 3523 c-12 -2 -30 -16 -40 -31 -15 -23 -17 -55 -17 -255 l0 -229 28 -24 c38 -32 90 -32 122 1 23 22 25 31 25 125 0 55 3 100 7 100 4 0 100 -92 213 -205 194 -193 208 -205 243 -205 52 0 87 35 87 87 0 36 -10 48 -205 243 -113 113 -205 208 -205 212 0 5 43 8 96 8 52 0 104 5 116 11 31 17 50 71 37 108 -20 56 -44 61 -276 60 -114 -1 -218 -4 -231 -6z">
                                    </path>
                                </g>
                            </svg>

                            <svg xmlns="http://www.w3.org/2000/svg" class="svg-video" id="enter-fullscreen-icon"
                                version="1.0" viewBox="0 0 500 500" preserveAspectRatio="xMidYMid meet">
                                <g transform="translate(-85,640) scale(0.1,-0.1)" stroke="none">
                                    <path
                                        d="M2839 4421 c-24 -19 -24 -20 -24 -235 0 -209 1 -216 22 -238 30 -30 86 -30 116 0 19 19 23 36 26 113 l3 91 188 -186 c157 -156 192 -186 216 -186 60 0 103 55 83 108 -5 15 -92 109 -192 210 l-182 182 93 0 c85 0 95 2 117 25 16 15 25 36 25 55 0 19 -9 40 -25 55 -24 25 -25 25 -233 25 -192 0 -212 -2 -233 -19z">
                                    </path>
                                    <path
                                        d="M3845 4415 c-16 -15 -25 -36 -25 -55 0 -19 9 -40 25 -55 22 -23 32 -25 115 -25 49 0 90 -3 90 -8 0 -4 -83 -90 -185 -192 -173 -173 -185 -187 -185 -222 0 -44 36 -78 83 -78 27 0 57 26 218 186 l188 187 6 -36 c4 -19 5 -52 2 -73 -10 -69 30 -124 89 -124 9 0 29 13 45 30 l30 30 -3 211 c-3 208 -3 211 -27 230 -21 17 -41 19 -233 19 -208 0 -209 0 -233 -25z">
                                    </path>
                                    <path
                                        d="M3370 3523 c-8 -3 -99 -89 -202 -192 l-188 -186 0 83 c0 86 -15 134 -45 146 -53 20 -108 -6 -120 -57 -4 -13 -5 -110 -3 -215 4 -257 -18 -237 257 -237 208 0 210 0 235 24 26 24 33 61 20 96 -12 30 -60 45 -146 45 l-83 0 190 190 c175 175 189 192 189 225 0 54 -56 96 -104 78z">
                                    </path>
                                    <path
                                        d="M3723 3520 c-28 -11 -43 -40 -43 -81 0 -29 21 -54 187 -221 l187 -188 -83 0 c-82 0 -115 -9 -138 -39 -20 -26 -15 -68 11 -98 l24 -28 185 -3 c208 -4 257 4 275 43 8 17 12 95 12 226 0 199 0 200 -25 224 -33 34 -83 34 -115 0 -21 -22 -23 -35 -24 -115 -1 -49 -3 -90 -6 -90 -2 0 -90 86 -195 190 -191 190 -204 199 -252 180z">
                                    </path>
                                </g>
                            </svg>

                        </div>
                    </div>
                </div>

                <div>
                    <% if(usernameNormalizedFriend && opt==2){%>
                    <input type="hidden" id="caller-username" name="caller-username"
                        value="<%= usernameNormalizedFriend%>">
                    <% } %>
                </div>


            </div>
        </div>
    </div>
    </div>

    <script>

        //fullscreen
        var fullScreenBtn = document.getElementById("screen-btn");
        fullScreenBtn.addEventListener("click", toggleFullScreen);

        function toggleFullScreen() {
            var remoteVideo = document.getElementById("remoteVideo");
            if (fullScreenStatus()) {
                changeFullScreenIcon("enter");
                fullScreenBtn.classList.remove("active");
                closeFullscreen();
            } else {
                changeFullScreenIcon("exit");
                fullScreenBtn.classList.add("active");
                openFullscreen();
            }
        }

        function fullScreenStatus() {
            if (document.fullscreenElement || document.webkitFullscreenElement ||
                document.mozFullScreenElement || (document.msFullscreenElement !== undefined)) {
                return true;
            }
            else {
                return false;
            }
        }

        var elem = document.getElementById("callPage");
        function openFullscreen() {
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) { /* Firefox */
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE/Edge */
                elem.msRequestFullscreen();
            }

        }

        function closeFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) { /* Firefox */
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE/Edge */
                document.msExitFullscreen();
            }

        }

        function changeFullScreenIcon(mode) {
            var iconEnterFullScreen = document.getElementById("enter-fullscreen-icon");
            var iconExitFullScreen = document.getElementById("exit-fullscreen-icon");
            if (mode === "enter") {
                iconExitFullScreen.style.display = "none";
                iconEnterFullScreen.style.display = "block";
            } else if (mode === "exit") {
                iconEnterFullScreen.style.display = "none";
                iconExitFullScreen.style.display = "block";
            }
        }

        //mute audio: que el otro no oiga mi audio
        var muteAudioBtn = document.getElementById("mute-audio-btn");
        muteAudioBtn.addEventListener("click", toggleMuteAudio)
        function toggleMuteAudio() {
            //no oir yo al otro
            // var remoteVideo = document.getElementById("remoteVideo");
            // remoteVideo.muted = true;

            //que el otro no oiga mi audio
            const tracksAudio = myLocalStream.getAudioTracks();

            if (tracksAudio[0].enabled) {
                changeMuteAudioIcon("mute")
                muteAudioBtn.classList.add("active");

            } else {
                changeMuteAudioIcon("unmute")
                muteAudioBtn.classList.remove("active");
            }

            tracksAudio[0].enabled = !tracksAudio[0].enabled //lo niego
        }

        function changeMuteAudioIcon(setMode) {
            var iconMutedAudio = document.getElementById("muted-audio-icon");
            var iconUnmutedAudio = document.getElementById("unmuted-audio-icon");
            if (setMode === "mute") {
                iconUnmutedAudio.style.display = "none";
                iconMutedAudio.style.display = "block";
            } else if (setMode === "unmute") {
                iconMutedAudio.style.display = "none";
                iconUnmutedAudio.style.display = "block";
            }
        }

        //mute video: que el otro no vea mi video
        var muteVideoBtn = document.getElementById("mute-video-btn");
        muteVideoBtn.addEventListener("click", toggleMuteVideo)
        function toggleMuteVideo() {
            const tracksVideo = myLocalStream.getVideoTracks();
            if (tracksVideo[0].enabled) {
                changeMuteVideoIcon("mute")
                muteVideoBtn.classList.add("active");
            } else {
                changeMuteVideoIcon("unmute")
                muteVideoBtn.classList.remove("active");
            }
            tracksVideo[0].enabled = !tracksVideo[0].enabled
        }

        function changeMuteVideoIcon(setMode) {
            var iconMutedVideo = document.getElementById("muted-video-icon");
            var iconUnmutedVideo = document.getElementById("unmuted-video-icon");
            if (setMode === "mute") {
                iconUnmutedVideo.style.display = "none";
                iconMutedVideo.style.display = "block";
            } else if (setMode === "unmute") {
                iconMutedVideo.style.display = "none";
                iconUnmutedVideo.style.display = "block";
            }
        }

        function showTopMsg(msg) {
            var msgText = document.getElementById("msg-text");
            msgText.innerText = msg;
            var divMsg = document.getElementById("show-msg");
            divMsg.style.height = "100px";
        }

        function photoStatus(status) {
            var image = document.getElementById("remoteuser-image");
            switch (status) {
                case "calling":
                case "receivingcalling":
                    image.style.display = "block";
                    //compruebo si no tiene la clase para no ponerla 2 veces
                    image.classList.add("call");
                    break;
                case "talking":
                    image.style.display = "none";
                    break;
                case "hangup":
                    image.style.display = "block";
                    image.classList.remove("call");
                    break;
                default:
                // code block
            }

        }


      //onload
      // document.getElementById("callBtn").addEventListener("click", f)
      // function f() {
      //    //get remoteVideo dimensiones
      //    var divRv = document.getElementById("remoteVideo");
      //    divRvHeight = divRv.clientHeight;
      //    divRvWidth = divRv.clientWidth;
      //    console.log(divRvHeight);
      //    console.log(divRvWidth);

      //    //give to localVideo same dimensions but smaller
      //    var divLv = document.getElementById("localVideo");
      //    divLv.style.height = divRvHeight / 5;
      //    divLv.style.width = divRvWidth / 5;
      // }

      //detect div#remoteVideo resize
      //poner en una linea
      // function outputsize() {
      //    // width.value = textbox.offsetWidth
      //    // height.value = textbox.offsetHeight
      //    console.log(2)
      //    f();
      // }
      // outputsize()

      // var rdiv = document.getElementById("remoteVideo");
      // new ResizeObserver(outputsize).observe(rdiv)

      //detect window resize
      //div#callPage width y height es relativo al tamaño de la browser window, 
      //por lo que si cambia la width o height de la browser window, cambia la de div#callPage
      //window.addEventListener("resize", f);

      //detect window orientation change
      // window.addEventListener("orientationchange", f);



    </script>
    <%- include('../includes/end.ejs') %>